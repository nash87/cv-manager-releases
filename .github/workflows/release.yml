name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  GO_VERSION: '1.21'
  WAILS_VERSION: '2.11.0'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v${{ env.WAILS_VERSION }}

      - name: Get version info
        id: version
        shell: pwsh
        run: |
          # Read current version from version.go
          $content = Get-Content -Path "version.go" -Raw
          $major = [regex]::Match($content, 'MajorVersion\s*=\s*(\d+)').Groups[1].Value
          $minor = [regex]::Match($content, 'MinorVersion\s*=\s*(\d+)').Groups[1].Value
          $patch = [regex]::Match($content, 'PatchVersion\s*=\s*(\d+)').Groups[1].Value
          $version = "$major.$minor.$patch"

          # Get git info
          $commit = git rev-parse --short HEAD
          $branch = git rev-parse --abbrev-ref HEAD
          $commitMsg = git log -1 --pretty=%B
          $commitDate = git log -1 --format=%ci

          # Set outputs
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "commit=$commit" >> $env:GITHUB_OUTPUT
          echo "branch=$branch" >> $env:GITHUB_OUTPUT
          echo "commit_msg=$commitMsg" >> $env:GITHUB_OUTPUT
          echo "commit_date=$commitDate" >> $env:GITHUB_OUTPUT

          Write-Host "Version: $version"
          Write-Host "Commit: $commit"

      - name: Build Main App
        run: |
          wails build -ldflags "-X main.BuildTime=${{ steps.version.outputs.commit_date }} -X main.GitCommit=${{ steps.version.outputs.commit }} -X main.GitBranch=${{ steps.version.outputs.branch }}"

      - name: Build Launcher
        working-directory: launcher
        run: |
          wails build

      - name: Calculate SHA256
        id: sha256
        shell: pwsh
        run: |
          $appHash = (Get-FileHash -Path "build/bin/cv-manager-pro.exe" -Algorithm SHA256).Hash.ToLower()
          $launcherHash = (Get-FileHash -Path "launcher/build/bin/cv-manager-launcher.exe" -Algorithm SHA256).Hash.ToLower()
          $appSize = [math]::Round((Get-Item "build/bin/cv-manager-pro.exe").Length / 1MB, 1)
          $launcherSize = [math]::Round((Get-Item "launcher/build/bin/cv-manager-launcher.exe").Length / 1MB, 1)

          echo "app_hash=$appHash" >> $env:GITHUB_OUTPUT
          echo "launcher_hash=$launcherHash" >> $env:GITHUB_OUTPUT
          echo "app_size=$appSize" >> $env:GITHUB_OUTPUT
          echo "launcher_size=$launcherSize" >> $env:GITHUB_OUTPUT

      - name: Generate version.json
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $commit = "${{ steps.version.outputs.commit }}"
          $commitMsg = "${{ steps.version.outputs.commit_msg }}"
          $date = Get-Date -Format "yyyy-MM-dd"

          # Main App version.json
          $appJson = @{
            latest_version = $version
            release_date = $date
            download_url = "https://github.com/nash87/cv-manager-pro-releases/releases/download/v$version/cv-manager-pro.exe"
            changelog_url = "https://github.com/nash87/cv-manager-pro-releases/releases/tag/v$version"
            release_notes = $commitMsg.Trim()
            sha256 = "${{ steps.sha256.outputs.app_hash }}"
            size_mb = [int]"${{ steps.sha256.outputs.app_size }}"
            is_required = $false
            commit_hash = $commit
          } | ConvertTo-Json -Depth 10

          $appJson | Out-File -FilePath "version.json" -Encoding UTF8

          # Launcher version.json
          $launcherJson = @{
            latest_version = "1.0.2"
            release_date = $date
            download_url = "https://github.com/nash87/cv-manager-pro-releases/releases/download/v$version/cv-manager-launcher.exe"
            changelog_url = "https://github.com/nash87/cv-manager-pro-releases/releases/tag/v$version"
            release_notes = "Launcher update for v$version"
            sha256 = "${{ steps.sha256.outputs.launcher_hash }}"
            size_mb = [int]"${{ steps.sha256.outputs.launcher_size }}"
            is_required = $false
            commit_hash = $commit
          } | ConvertTo-Json -Depth 10

          $launcherJson | Out-File -FilePath "launcher-version.json" -Encoding UTF8

          Write-Host "Generated version.json:"
          Get-Content "version.json"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: CV Manager Pro v${{ steps.version.outputs.version }}
          body: |
            ## CV Manager Pro v${{ steps.version.outputs.version }}

            **Release Date:** ${{ steps.version.outputs.commit_date }}
            **Commit:** ${{ steps.version.outputs.commit }}

            ### Changes
            ${{ steps.version.outputs.commit_msg }}

            ### Downloads
            - `cv-manager-pro.exe` - Main Application
            - `cv-manager-launcher.exe` - Auto-Update Launcher

            ### Checksums (SHA256)
            - App: `${{ steps.sha256.outputs.app_hash }}`
            - Launcher: `${{ steps.sha256.outputs.launcher_hash }}`
          files: |
            build/bin/cv-manager-pro.exe
            launcher/build/bin/cv-manager-launcher.exe
            version.json
            launcher-version.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version files in repo
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add version.json launcher-version.json
          git commit -m "Update version files for v${{ steps.version.outputs.version }}" || echo "No changes"
          git push || echo "Push failed"
